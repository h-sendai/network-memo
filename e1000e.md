# E1000E コントローラマニュアルを読んでのメモ

Intel 8257x Contoller データシート (Linuxではドライバ名e1000eのもの)
https://sourceforge.net/projects/e1000/files/8257x%20Developer%20Manual/Revision%201.8/

を読んだときのメモ。これが一番シンプルそうだったのでこれをまず読んでみる。

## 3.2.3 Receive Descriptor Queue Structure

Figure 3-1に受信デスクリプタリングの構造がかいてある。

```
            Curcular Buffer Queue
            +---------------------+
Base ------>| ////////////////////|
            +---------------------+
            | ////////////////////|
            +---------------------+
            |                     | <---- Head
            +---------------------+
Owned by    |                     | 
hardware    +---------------------+ 
            |                     | Receive Queue
            +---------------------+  
            |                     |
            +---------------------+
            |                     |
            +---------------------+
            |                     |
            +---------------------+
            |/////////////////////| <---- Tail
            +---------------------+
            |/////////////////////|
            +---------------------+
            |/////////////////////|
Base + size +---------------------+
```

``|/////|``の部分はパケットが到来したがまだ
ソフトウェアがまだ認識していない部分を示す。

- headとtailは16バイトのデスクリプタをさしている。
- ``head == tail``のときにはリングは空であることを示す。
- headポインタは次にハードウェアが次に書くデスクリプタをさしている。
正常にかけたら書いた分だけheadポインタを進める。

受信リングバッファを表現しているレジスタは以下の4個:

- 受信デスクリプタベースアドレスレジスタ (RDBA0, RDBA1)<br>
これはデスクリプタリングバッファの開始位置を示している。
RDBA0, RDBA1は32ビットで計64ビット。
- 受信デスクリプタ長さレジスタ (RDLEN0, RDLEN1)<br>
リングバッファの長さ（単位はバイト）。
128の倍数である必要がある。128はキャッシュラインサイズの最大値。
それぞれのデスクリプタは16バイトなので128/16 = 8で8の倍数になっている。
- 受信デスクリプタヘッドレジスタ （RDH0、RDH1）<br>
ベースアドレスからのオフセット。最大64kBのデスクリプタを
リングバッファで保持できる。
- 受信デスクリプタテイルレジスタ （RDT0, RDT1）
ベースアドレスからのオフセット。ハードウェアが処理できる
最後のデスクリプタの次のデスクリプタをさしている。

## 3.2.4 Receive Descriptor Format

受信デスクリプタは受信データバッファのアドレス、および
ハードウェアのためのパケット情報を保持するデータ構造体となっている。

```
    63
  +-----------------------------------------------------------------+
0 |                       Buffer Address (63:0)                     |
  +-----------------------------------------------------------------+
8 |VLANG Tag (16)|Errors (8)|Status(8)|Packet checksum(16)|Length(16)
  +-----------------------------------------------------------------+
```

- 2行目のカッコ内はビット長。
- 2行目はハードウェアがパケット到着で書き換えるデータ領域。
- パケットを受信するとイーサネットコントローラはBuffer Addressが指し示す
領域にデータを保存し、長さ、パケットチェックサム、ステータス、エラー
情報を書く。
- LengthはCRCバイト長を含んだ保存データ長。
